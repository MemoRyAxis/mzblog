---
title: 跨数据库实现关联查询的方案及对比
date: 2018-04-07 17:57:39
tags:
---

微服务的架构越来越多的应用于各个公司和项目中, 但其对技术架构也提出了各式各样的要求, 如服务治理, 自动化运维, 数据库架构等.
由于实现微服务后, 数据库会按具体的业务线进行拆分, 如何实现跨数据库的关联查询便是首要问题之一.
本文主要讨论一些跨数据库实现关联查询的方案及相关的优缺点, 供大家参考.


## 1. 方案介绍

### 方案1: 字段冗余

主库将需要关联或查询的从库字段进行冗余, 从库数据更新需要定时或使用 MQ 等对冗余字段进行同步.
例: 订单表中直接不仅保存用户的 ID, 还保存用户名, 这样在查询订单详情时便不需要再次查询用户表.

优点: 单表查询效率高
缺点: 业务数据冗余, 数据更新同步

### 方案2: 库表同步

使用中间件将需要的表或字段同步至缓存或搜索引擎中, 再直接从缓存或搜索引擎中获取数据.
例: 实时抓取订单, 用户等库的插入和更新数据, 并将关联数据进行拼接保存至搜索引擎, 获取时直接查询搜索引擎.

优点: 对业务无侵入, 解耦程度高
缺点: 数据同步延时, 三方依赖过多

### 方案3: 数据拼装

通过现有接口对各个系统的数据进行查询并拼装成想要的结果.
例: 查询订单明细时先调用订单服务, 再使用订单中的 ID 等信息查询用户服务, 最后将所有数据拼装成结果.

优点: 对业务无侵入, 能保证数据时效性
缺点: 性能低, 可扩展性差


## 2. 方案对比

### 对比项

+ 实时性: 从库更新后是否能实时获取到最新数据
    + 实时
    + 非实时
+ 耦合度: 这里专指业务数据的侵入程度
    + 低
    + 一般
    + 高
+ 第三方依赖: 除数据库之外的第三方存储, 同步中间件等
    + 无
    + 部分依赖
    + 较多依赖
+ 可扩展性: 添加相关的新功能时的能力
    + 高
    + 一般
    + 低
+ 可靠性: 低宕机概率, 是否可恢复, 是否可回滚等
    + 高
    + 一般
    + 低
+ 稳定性: 可用性, 可维护性, 故障恢复时间等
    + 高
    + 一般
    + 低
    
### 具体对比

| 方案名称 | 实时性 | 耦合度 | 第三方依赖        | 可扩展性 |
| :-:      | :-:    | :-:    | :-:               | :-:      |
| 字段冗余 | 非实时 | 高     | 无 (同步数据则有) | 一般     |
| 库表同步 | 非实时 | 低     | 较多依赖          | 高       |
| 数据拼装 | 实时   | 低     | 无                | 低       |


## 3. 场景分析

### 场景1: 跨库关联非强需求

整理好思路, 准备好替代方案, 说服需求方不使用跨库关联来实现功能

### 场景2: 其他

务必充分评估需求, 思考可能存在的风险, 考量未来可能的需求和扩展, 具体可以参考2中的对比项

然后去找需求方讨论工期, 告诉他们: 注意! 这不是演习


## 相关链接

1. [Databus](https://github.com/linkedin/databus)
